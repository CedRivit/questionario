document.getElementById('contactForm').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    btn.disabled = true; 
    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> INVIO IN CORSO...`;
    
    const prefCell = document.getElementById('prefixCell').classList.contains('hidden') ? document.getElementById('manualCell').value : document.getElementById('prefixCell').value;
    const prefTel = document.getElementById('prefixTel').classList.contains('hidden') ? document.getElementById('manualTel').value : document.getElementById('prefixTel').value;

    let photoFileName = "";
    if (compressedImageBase64) {
        photoFileName = `IMG_${Date.now()}.jpg`;
        const photoOk = await uploadImage(photoFileName);
        if (!photoOk) { 
            alert("Errore durante il caricamento della foto. Riprova."); 
            btn.disabled = false; 
            btn.innerText = "SALVA CONTATTO";
            return; 
        }
    }

    const data = {
        azienda: document.getElementById('azienda').value,
        nomeCognome: document.getElementById('nomeCognome').value,
        indirizzo: document.getElementById('indirizzo').value,
        cell: prefCell + " " + document.getElementById('cell').value,
        tel: prefTel + " " + document.getElementById('tel').value,
        occupazione: document.getElementById('occupazione').value,
        cerco: document.getElementById('cerco').value,
        foto: photoFileName,
        timestamp: new Date().toLocaleString('it-IT')
    };

    allContacts.unshift(data);
    const url = `https://api.github.com/repos/${config.repo}/contents/data.json`;
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(allContacts, null, 2))));
    const body = { message: `Inserimento: ${data.nomeCognome}`, content, sha: fileSha };
    
    try {
        const res = await fetch(url, { 
            method: "PUT", 
            headers: { "Authorization": `token ${config.token}`, "Content-Type": "application/json" }, 
            body: JSON.stringify(body) 
        });

        if (res.ok) { 
            // MESSAGGIO DI RINGRAZIAMENTO PERSONALIZZATO
            alert("Grazie per aver fornito i tuoi dati.\n\nSarà cura del nostro reparto commerciale ricontattarla al più presto.\n\nRIVIT S.p.A SB"); 
            location.reload(); 
        } else { 
            throw new Error(); 
        }
    } catch (err) {
        alert("Si è verificato un errore durante il salvataggio. Controlla la connessione.");
        btn.disabled = false;
        btn.innerText = "SALVA CONTATTO";
    }
};
