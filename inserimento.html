<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>RIVIT S.p.A SB - Contact Form</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    body {
        background-image: url('intro.jpg');
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        min-height: 100vh;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .glass-panel {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255,255,255,0.4);
        border-radius: 2rem;
    }
    .status-dot {
        height: 8px;
        width: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 6px;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    .syncing { animation: pulse 1.5s infinite; }
</style>
</head>
<body class="antialiased text-slate-900">

<div class="w-full max-w-2xl mx-auto p-4 sm:p-6 lg:p-8">

    <!-- Header -->
    <header class="mb-6">
        <div class="glass-panel p-4 sm:p-6 shadow-2xl flex justify-between items-center border-b-4 border-red-600">
            <div class="flex items-center gap-3">
                <img src="FOTO1.jpg" alt="RIVIT Logo" class="h-14 w-auto">
                <h1 class="text-2xl font-extrabold tracking-tight text-slate-800">RIVIT S.p.A SB</h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex items-center bg-white/80 px-3 py-1 rounded-full border border-slate-200 shadow-sm cursor-pointer" onclick="refreshCloud()">
                    <span id="statusDot" class="status-dot bg-slate-300"></span>
                    <span id="statusText" class="text-[10px] font-bold uppercase text-slate-500 italic">Cloud Offline</span>
                </div>
                <button onclick="logout()" class="px-3 py-1 bg-red-600 text-white rounded-full text-xs font-bold shadow-lg">Reset Cloud</button>
            </div>
        </div>
    </header>

    <!-- Main Form -->
    <main class="glass-panel p-6 sm:p-8 shadow-2xl border-b-4 border-slate-200">
        <form id="contactForm" class="space-y-6">

            <!-- Personal Info -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="sm:col-span-2">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase ml-2 mb-1 italic">Company</label>
                    <input type="text" id="company" required class="w-full p-3 bg-white border border-slate-200 rounded-2xl outline-none focus:border-red-500" placeholder="Business Name">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase ml-2 mb-1 italic">Full Name</label>
                    <input type="text" id="fullName" required class="w-full p-3 bg-white border border-slate-200 rounded-2xl outline-none focus:border-red-500" placeholder="First and Last Name">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase ml-2 mb-1 italic">City</label>
                    <input type="text" id="city" required class="w-full p-3 bg-white border border-slate-200 rounded-2xl outline-none focus:border-red-500" placeholder="City">
                </div>
            </div>

            <!-- Phone Fields -->
            <script>
                const countries = [
                    {name:"Italy", code:"+39", flag:"ðŸ‡®ðŸ‡¹"}, {name:"USA", code:"+1", flag:"ðŸ‡ºðŸ‡¸"}, {name:"UK", code:"+44", flag:"ðŸ‡¬ðŸ‡§"},
                    {name:"Germany", code:"+49", flag:"ðŸ‡©ðŸ‡ª"}, {name:"France", code:"+33", flag:"ðŸ‡«ðŸ‡·"}, {name:"Spain", code:"+34", flag:"ðŸ‡ªðŸ‡¸"},
                    {name:"Canada", code:"+1", flag:"ðŸ‡¨ðŸ‡¦"}, {name:"Australia", code:"+61", flag:"ðŸ‡¦ðŸ‡º"}, {name:"Switzerland", code:"+41", flag:"ðŸ‡¨ðŸ‡­"},
                    {name:"Belgium", code:"+32", flag:"ðŸ‡§ðŸ‡ª"}, {name:"Netherlands", code:"+31", flag:"ðŸ‡³ðŸ‡±"}, {name:"Norway", code:"+47", flag:"ðŸ‡³ðŸ‡´"},
                    {name:"Sweden", code:"+46", flag:"ðŸ‡¸ðŸ‡ª"}, {name:"Finland", code:"+358", flag:"ðŸ‡«ðŸ‡®"}, {name:"Denmark", code:"+45", flag:"ðŸ‡©ðŸ‡°"},
                    {name:"Ireland", code:"+353", flag:"ðŸ‡®ðŸ‡ª"}, {name:"Japan", code:"+81", flag:"ðŸ‡¯ðŸ‡µ"}, {name:"China", code:"+86", flag:"ðŸ‡¨ðŸ‡³"}
                ];
                function countryOptions() {
                    return countries.map(c=>`<option value="${c.code}">${c.flag} ${c.name} (${c.code})</option>`).join('') + `<option value="manual">âž• Other...</option>`;
                }
            </script>

            <div class="space-y-4">
                <label class="block text-[10px] font-bold text-slate-400 uppercase ml-2 mb-1 italic">Phone Contacts</label>
                <div class="flex flex-col sm:flex-row gap-2">
                    <div class="flex flex-1 gap-2">
                        <select id="prefixMobile" onchange="toggleManual('prefixMobile','manualMobile')" class="w-44 p-3 bg-white border border-slate-200 rounded-2xl font-bold text-[11px] outline-none">
                            <script>document.write(countryOptions());</script>
                        </select>
                        <input type="text" id="manualMobile" placeholder="+00" class="hidden w-24 p-3 bg-red-50 border border-red-200 rounded-2xl outline-none font-bold text-sm">
                        <input type="tel" id="mobile" required placeholder="Mobile Number" class="flex-1 p-3 bg-white border border-slate-200 rounded-2xl outline-none focus:border-red-500">
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row gap-2">
                    <div class="flex flex-1 gap-2">
                        <select id="prefixLandline" onchange="toggleManual('prefixLandline','manualLandline')" class="w-44 p-3 bg-white border border-slate-200 rounded-2xl font-bold text-[11px] outline-none">
                            <script>document.write(countryOptions());</script>
                        </select>
                        <input type="text" id="manualLandline" placeholder="+00" class="hidden w-24 p-3 bg-red-50 border border-red-200 rounded-2xl outline-none font-bold text-sm">
                        <input type="tel" id="landline" placeholder="Landline Number" class="flex-1 p-3 bg-white border border-slate-200 rounded-2xl outline-none focus:border-red-500">
                    </div>
                </div>
            </div>

            <!-- Business Info -->
            <div class="grid grid-cols-1 gap-4">
                <textarea id="activity" rows="2" required class="w-full p-4 bg-white border border-slate-200 rounded-2xl outline-none focus:border-red-500" placeholder="What is your business activity?"></textarea>
                <textarea id="lookingFor" rows="2" required class="w-full p-4 bg-white border border-slate-200 rounded-2xl outline-none focus:border-red-500" placeholder="What are you looking for from Rivit?"></textarea>
            </div>

            <!-- Business Card Photo -->
            <div class="p-4 border-2 border-dashed border-red-100 rounded-3xl bg-red-50/30">
                <label class="block text-[10px] font-bold text-red-600 uppercase mb-3 text-center tracking-widest italic">Business Card Photo</label>
                <div class="flex flex-col items-center gap-3">
                    <input type="file" id="photoInput" accept="image/*" capture="environment" class="hidden">
                    <button type="button" onclick="document.getElementById('photoInput').click()" class="bg-slate-800 text-white px-8 py-3 rounded-full text-[10px] font-bold uppercase flex items-center gap-2 shadow-lg">
                        <i class="fas fa-camera text-sm"></i> Take Photo
                    </button>
                    <div id="previewArea" class="hidden w-full max-w-[200px] relative mt-2">
                        <img id="imgPreview" src="" class="w-full rounded-2xl border-4 border-white shadow-xl">
                        <button type="button" onclick="resetPhoto()" class="absolute -top-3 -right-3 bg-red-600 text-white w-7 h-7 rounded-full text-xs shadow-lg flex items-center justify-center"><i class="fas fa-times"></i></button>
                    </div>
                </div>
            </div>

            <!-- Buttons -->
            <div class="flex flex-col sm:flex-row gap-3">
                <button type="button" onclick="if(confirm('Cancel the entry?')) location.reload()" class="w-full sm:w-1/3 py-4 bg-slate-200 text-slate-600 font-bold rounded-3xl uppercase tracking-widest text-xs">Cancel</button>
                <button type="submit" id="submitBtn" class="w-full sm:w-2/3 py-5 bg-red-600 text-white font-bold rounded-3xl shadow-xl active:scale-95 transition-all flex justify-center items-center gap-4 uppercase tracking-widest text-sm">
                    <i class="fas fa-save"></i> Save Contact
                </button>
            </div>

        </form>
    </main>
</div>

<script>
// Configuration for GitHub repo
let config = JSON.parse(localStorage.getItem('gh_crm_config'));
let fileSha = "";
let allContacts = [];
let compressedImageBase64 = "";

// Cloud connection
async function ghFetch() {
    if(!config) return;
    const url = `https://api.github.com/repos/${config.repo}/contents/data.json`;
    try {
        const res = await fetch(url,{headers:{"Authorization":`token ${config.token}`}, cache:'no-store'});
        if(res.ok){
            const data = await res.json();
            fileSha = data.sha;
            allContacts = JSON.parse(decodeURIComponent(escape(atob(data.content))));
            document.getElementById('statusDot').className="status-dot bg-green-500";
            document.getElementById('statusText').innerText="Cloud Active";
        } else {
            document.getElementById('statusText').innerText="Cloud Offline";
        }
    } catch(e) {
        document.getElementById('statusText').innerText="Cloud Offline";
    }
}

// Refresh button
function refreshCloud() { ghFetch(); }

// Logout / reset
function logout() {
    if(confirm("Reset Cloud?")){
        localStorage.removeItem('gh_crm_config');
        location.reload();
    }
}

// Phone manual toggle
function toggleManual(selectId, manualId){
    const sel=document.getElementById(selectId);
    const man=document.getElementById(manualId);
    if(sel.value==="manual"){ man.classList.remove('hidden'); sel.classList.add('hidden'); man.focus(); }
}

// Photo capture
document.getElementById('photoInput').onchange = function(e){
    const file=e.target.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload = function(event){
        const img=new Image(); img.src=event.target.result;
        img.onload = function(){
            const canvas=document.createElement('canvas'); const MAX=1000;
            let w=img.width, h=img.height; if(w>MAX){ h*=MAX/w; w=MAX; }
            canvas.width=w; canvas.height=h;
            canvas.getContext('2d').drawImage(img,0,0,w,h);
            compressedImageBase64=canvas.toDataURL('image/jpeg',0.7);
            document.getElementById('imgPreview').src=compressedImageBase64;
            document.getElementById('previewArea').classList.remove('hidden');
        }
    }
    reader.readAsDataURL(file);
};
function resetPhoto(){ compressedImageBase64=""; document.getElementById('photoInput').value=""; document.getElementById('previewArea').classList.add('hidden'); }

// Form submission
document.getElementById('contactForm').onsubmit = async function(e){
    e.preventDefault();
    const btn=document.getElementById('submitBtn'); btn.disabled=true; btn.innerText="SAVING...";

    const prefMobile = document.getElementById('prefixMobile').classList.contains('hidden') ? document.getElementById('manualMobile').value : document.getElementById('prefixMobile').value;
    const prefLandline = document.getElementById('prefixLandline').classList.contains('hidden') ? document.getElementById('manualLandline').value : document.getElementById('prefixLandline').value;

    let photoFileName="";
    if(compressedImageBase64){
        photoFileName=`IMG_${Date.now()}.jpg`;
        const url = `https://api.github.com/repos/${config.repo}/contents/allegati/${photoFileName}`;
        const content = compressedImageBase64.split(',')[1];
        const body={message:`Photo: ${photoFileName}`, content};
        const res = await fetch(url,{method:"PUT", headers:{"Authorization":`token ${config.token}`,"Content-Type":"application/json"}, body:JSON.stringify(body)});
        if(!res.ok){ alert("Error uploading photo"); btn.disabled=false; btn.innerText="Save Contact"; return; }
    }

    const data={
        company: document.getElementById('company').value,
        fullName: document.getElementById('fullName').value,
        city: document.getElementById('city').value,
        mobile: prefMobile + " " + document.getElementById('mobile').value,
        landline: prefLandline + " " + document.getElementById('landline').value,
        activity: document.getElementById('activity').value,
        lookingFor: document.getElementById('lookingFor').value,
        photo: photoFileName,
        timestamp: new Date().toLocaleString()
    };

    allContacts.unshift(data);
    const url=`https://api.github.com/repos/${config.repo}/contents/data.json`;
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(allContacts,null,2))));
    const body={message:`Entry: ${data.fullName}`, content, sha:fileSha};
    const res = await fetch(url,{method:"PUT", headers:{"Authorization":`token ${config.token}`,"Content-Type":"application/json"}, body:JSON.stringify(body)});
    if(res.ok){
        alert("Thank you for submitting your data.\nOur sales team will contact you shortly.");
        location.reload();
    } else {
        alert("Error saving data.");
        btn.disabled=false; btn.innerText="Save Contact";
    }
};

// Initial cloud fetch
if(config) ghFetch();
</script>

</body>
</html>
